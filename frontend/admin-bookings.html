<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buchungen verwalten - Gassigeher Admin</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <header>
        <div class="container">
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
            <a href="/" class="logo">üêï Gassigeher Admin</a>
            <nav id="main-nav">
                <ul>
                    <li><a href="/admin-dashboard.html" data-i18n="admin_dashboard.title">Dashboard</a></li>
                    <li><a href="/admin-dogs.html" data-i18n="dogs.manage_dogs">Hunde</a></li>
                    <li><a href="/admin-bookings.html" data-i18n="admin.manage_bookings">Buchungen</a></li>
                    <li><a href="/admin-blocked-dates.html" data-i18n="admin.manage_blocked_dates">Gesperrte Tage</a></li>
                    <li><a href="/admin-experience-requests.html" data-i18n="admin.manage_experience_requests">Level-Anfragen</a></li>
                    <li><a href="/admin-users.html" data-i18n="users.title">Benutzer</a></li>
                    <li><a href="/admin-reactivation-requests.html" data-i18n="reactivation.manage_requests">Reaktivierungen</a></li>
                    <li><a href="/admin-booking-times.html" data-i18n="admin.booking_times">Buchungszeiten</a></li>
                    <li><a href="/admin-booking-approvals.html" data-i18n="admin.booking_approvals">Genehmigungen</a></li>
                    <li><a href="/admin-settings.html" data-i18n="admin_dashboard.system_settings">Einstellungen</a></li>
                    <li><a href="/dashboard.html" class="area-switcher" data-i18n="nav.user_area">üë§ Benutzer-Bereich</a></li>
                    <li><a href="#" onclick="api.logout()" data-i18n="nav.logout">Abmelden</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <div class="nav-overlay" id="nav-overlay" onclick="toggleMenu()"></div>

    <main style="padding: 40px 0;">
        <div class="container">
            <h1 data-i18n="admin.manage_bookings">Buchungen verwalten</h1>

            <div id="alert-container"></div>

            <!-- Pending Approvals Section -->
            <section class="card" id="pending-approvals-section" style="display: none;">
                <h2>Genehmigungsanfragen <span id="pending-count" class="badge" style="background: #82b965; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.9rem;">0</span></h2>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Uhrzeit</th>
                            <th>Benutzer</th>
                            <th>Hund</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="pending-approvals-table">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </section>

            <!-- Filters -->
            <div class="filter-bar">
                <h3 style="margin-bottom: 15px;">Filter</h3>
                <div class="filter-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label data-i18n="bookings.status">Status</label>
                        <select id="filter-status">
                            <option value="">Alle</option>
                            <option value="scheduled" data-i18n="bookings.status_scheduled">Geplant</option>
                            <option value="completed" data-i18n="bookings.status_completed">Abgeschlossen</option>
                            <option value="cancelled" data-i18n="bookings.status_cancelled">Storniert</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label data-i18n="bookings.date">Datum ab</label>
                        <input type="date" id="filter-date-from">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label data-i18n="bookings.date">Datum bis</label>
                        <input type="date" id="filter-date-to">
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="applyFilters()" data-i18n="common.apply">Anwenden</button>
                    <button class="btn btn-secondary" onclick="resetFilters()" data-i18n="common.reset">Zur√ºcksetzen</button>
                </div>
            </div>

            <!-- Bookings List -->
            <div id="bookings-list"></div>
        </div>
    </main>

    <script src="/js/nav-menu.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/api.js"></script>
    <script>
        let bookings = [];
        let dogs = {};
        let users = {};

        document.addEventListener('DOMContentLoaded', async () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            // Check if user is admin
            try {
                const userData = await api.getMe();
                if (!userData.is_admin) {
                    alert('Zugriff verweigert: Diese Seite ist nur f√ºr Administratoren zug√§nglich.');
                    window.location.href = '/dashboard.html';
                    return;
                }
            } catch (error) {
                console.error('Failed to verify admin status:', error);
                window.location.href = '/dashboard.html';
                return;
            }

            await window.i18n.load();

            // Explicitly update all translations after load
            console.log('i18n loaded, updating translations...');
            window.i18n.updateElement(document.body);

            loadBookings();
            loadPendingApprovals();

            // Refresh pending approvals every 30 seconds
            setInterval(loadPendingApprovals, 30000);
        });

        async function loadBookings() {
            try {
                const filters = getFilters();
                bookings = await api.getBookings(filters);

                // Load dog and user details
                const dogIds = [...new Set(bookings.map(b => b.dog_id))];
                const userIds = [...new Set(bookings.map(b => b.user_id))];

                await Promise.all(dogIds.map(async (id) => {
                    try {
                        dogs[id] = await api.getDog(id);
                    } catch (error) {
                        dogs[id] = { name: `Hund #${id}` };
                    }
                }));

                renderBookings();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Laden der Buchungen');
            }
        }

        function getFilters() {
            const filters = {};
            const status = document.getElementById('filter-status').value;
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;

            if (status) filters.status = status;
            if (dateFrom) filters.date_from = dateFrom;
            if (dateTo) filters.date_to = dateTo;

            return filters;
        }

        function applyFilters() {
            loadBookings();
        }

        function resetFilters() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            loadBookings();
        }

        function renderBookings() {
            const container = document.getElementById('bookings-list');

            if (bookings.length === 0) {
                container.innerHTML = '<div class="card"><p data-i18n="bookings.no_bookings">Keine Buchungen gefunden</p></div>';
                return;
            }

            container.innerHTML = bookings.map(booking => {
                const dog = dogs[booking.dog_id] || { name: `Hund #${booking.dog_id}` };
                const statusClass = booking.status === 'cancelled' ? 'alert-error' : (booking.status === 'completed' ? 'alert-success' : 'alert-info');

                return `
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                    <h4 style="margin: 0;">${dog.name}</h4>
                                    <span class="alert ${statusClass}" style="padding: 4px 12px; font-size: 0.8rem; margin: 0;">${getStatusLabel(booking.status)}</span>
                                </div>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Benutzer:</strong> User #${booking.user_id}
                                </p>
                                <p style="margin: 5px 0;">
                                    üìÖ ${booking.date} - ${booking.scheduled_time} Uhr
                                </p>
                                ${booking.admin_cancellation_reason ? `<p style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 4px;"><strong>Stornierungsgrund:</strong> ${booking.admin_cancellation_reason}</p>` : ''}
                                ${booking.user_notes ? `<p style="margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px;"><strong>Notizen:</strong> ${booking.user_notes}</p>` : ''}
                            </div>
                            ${booking.status === 'scheduled' ? `
                                <div style="display: flex; gap: 5px; flex-direction: column; min-width: 120px;">
                                    <button class="btn" style="padding: 8px 16px;" onclick="moveBooking(${booking.id})">Verschieben</button>
                                    <button class="btn btn-danger" style="padding: 8px 16px;" onclick="cancelBooking(${booking.id})">Stornieren</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusLabel(status) {
            const labels = {
                scheduled: 'Geplant',
                completed: 'Abgeschlossen',
                cancelled: 'Storniert'
            };
            return labels[status] || status;
        }

        async function cancelBooking(id) {
            const reason = prompt('Grund f√ºr die Stornierung:');
            if (!reason) return;

            try {
                await api.cancelBooking(id, reason);
                showAlert('success', 'Buchung storniert');
                loadBookings();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Stornieren');
            }
        }

        async function moveBooking(id) {
            const booking = bookings.find(b => b.id === id);
            if (!booking) return;

            const newDate = prompt('Neues Datum (JJJJ-MM-TT):', booking.date);
            if (!newDate) return;

            const newTime = prompt('Neue Uhrzeit (HH:MM):', booking.scheduled_time);
            if (!newTime) return;

            const reason = prompt('Grund f√ºr die Verschiebung:');
            if (!reason) return;

            try {
                await api.moveBooking(id, newDate, newTime, reason);
                showAlert('success', 'Buchung verschoben');
                loadBookings();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Verschieben');
            }
        }

        async function loadPendingApprovals() {
            try {
                const pendingBookings = await api.getPendingApprovalBookings();
                const table = document.getElementById('pending-approvals-table');
                const badge = document.getElementById('pending-count');
                const section = document.getElementById('pending-approvals-section');

                badge.textContent = pendingBookings.length;

                if (pendingBookings.length === 0) {
                    section.style.display = 'none';
                    return;
                }

                section.style.display = 'block';
                table.innerHTML = '';

                pendingBookings.forEach(booking => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${booking.date}</td>
                        <td>${booking.scheduled_time}</td>
                        <td>User #${booking.user_id}</td>
                        <td>${booking.dog_name || `Hund #${booking.dog_id}`}</td>
                        <td>
                            <button class="btn" style="padding: 6px 12px; background: #82b965;" onclick="approveBooking(${booking.id})">‚úì Genehmigen</button>
                            <button class="btn btn-danger" style="padding: 6px 12px; margin-left: 5px;" onclick="rejectBooking(${booking.id})">‚úó Ablehnen</button>
                        </td>
                    `;
                    table.appendChild(row);
                });
            } catch (error) {
                console.error('Failed to load pending approvals:', error);
            }
        }

        async function approveBooking(id) {
            if (!confirm('Buchung wirklich genehmigen?')) return;

            try {
                await api.approveBooking(id);
                showAlert('success', 'Buchung genehmigt!');
                loadPendingApprovals();
                loadBookings(); // Refresh main table
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Genehmigen');
            }
        }

        async function rejectBooking(id) {
            const reason = prompt('Grund f√ºr Ablehnung:');
            if (!reason) return;

            try {
                await api.rejectBooking(id, reason);
                showAlert('success', 'Buchung abgelehnt');
                loadPendingApprovals();
                loadBookings();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Ablehnen');
            }
        }

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>
</body>
</html>
