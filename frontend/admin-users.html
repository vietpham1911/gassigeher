<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benutzerverwaltung - Gassigeher Admin</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <header>
        <div class="container">
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
            <a href="/" class="logo">üêï Gassigeher Admin</a>
            <nav id="main-nav">
                <ul>
                    <li><a href="/admin-dashboard.html" data-i18n="admin_dashboard.title">Dashboard</a></li>
                    <li><a href="/admin-dogs.html" data-i18n="dogs.manage_dogs">Hunde</a></li>
                    <li><a href="/admin-bookings.html" data-i18n="admin.manage_bookings">Buchungen</a></li>
                    <li><a href="/admin-blocked-dates.html" data-i18n="admin.manage_blocked_dates">Gesperrte Tage</a></li>
                    <li><a href="/admin-experience-requests.html" data-i18n="admin.manage_experience_requests">Level-Anfragen</a></li>
                    <li><a href="/admin-users.html" data-i18n="users.title">Benutzer</a></li>
                    <li><a href="/admin-reactivation-requests.html" data-i18n="reactivation.manage_requests">Reaktivierungen</a></li>
                    <li><a href="/admin-settings.html" data-i18n="admin_dashboard.system_settings">Einstellungen</a></li>
                    <li><a href="/dashboard.html" class="area-switcher" data-i18n="nav.user_area">üë§ Benutzer-Bereich</a></li>
                    <li><a href="#" onclick="api.logout()" data-i18n="nav.logout">Abmelden</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <div class="nav-overlay" id="nav-overlay" onclick="toggleMenu()"></div>

    <main style="padding: 40px 0;">
        <div class="container">
            <h1 data-i18n="users.title">Benutzerverwaltung</h1>

            <div id="alert-container"></div>

            <!-- Filters -->
            <div class="filter-bar">
                <h3 style="margin-bottom: 15px;">Filter</h3>
                <div class="filter-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Status</label>
                        <select id="filter-status">
                            <option value="">Alle</option>
                            <option value="active" data-i18n="users.status_active">Aktiv</option>
                            <option value="inactive" data-i18n="users.status_inactive">Inaktiv</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="applyFilters()" data-i18n="common.apply">Anwenden</button>
                </div>
            </div>

            <!-- Users List -->
            <div id="users-list"></div>
        </div>
    </main>

    <script src="/js/nav-menu.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/api.js"></script>
    <script>
        let users = [];
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            // Check if user is admin
            try {
                currentUser = await api.getMe();
                if (!currentUser.is_admin) {
                    alert('Zugriff verweigert: Diese Seite ist nur f√ºr Administratoren zug√§nglich.');
                    window.location.href = '/dashboard.html';
                    return;
                }
            } catch (error) {
                console.error('Failed to verify admin status:', error);
                window.location.href = '/dashboard.html';
                return;
            }

            await window.i18n.load();

            // Explicitly update all translations after load
            console.log('i18n loaded, updating translations...');
            window.i18n.updateElement(document.body);

            loadUsers();
        });

        async function loadUsers() {
            try {
                const filterStatus = document.getElementById('filter-status').value;
                let activeOnly = null;
                if (filterStatus === 'active') activeOnly = true;
                if (filterStatus === 'inactive') activeOnly = false;

                users = await api.getUsers(activeOnly);
                renderUsers();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Laden der Benutzer');
            }
        }

        function applyFilters() {
            loadUsers();
        }

        function renderUsers() {
            const container = document.getElementById('users-list');

            if (users.length === 0) {
                container.innerHTML = '<div class="card"><p>Keine Benutzer gefunden</p></div>';
                return;
            }

            container.innerHTML = users.map(user => {
                const statusClass = user.is_active ? 'alert-success' : 'alert-error';
                const statusLabel = user.is_active ? 'Aktiv' : 'Inaktiv';
                const levelLabel = getLevelLabel(user.experience_level);

                // Determine role badge
                let roleBadge = '';
                if (user.is_super_admin) {
                    roleBadge = '<span class="badge-super-admin">Super Admin</span>';
                } else if (user.is_admin) {
                    roleBadge = '<span class="badge-admin">Admin</span>';
                } else {
                    roleBadge = '<span style="color: #666;">Benutzer</span>';
                }

                return `
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                    <h4 style="margin: 0;">${user.name}</h4>
                                    <span class="alert ${statusClass}" style="padding: 4px 12px; font-size: 0.8rem; margin: 0;">${statusLabel}</span>
                                    <span class="dog-category-badge ${user.experience_level}" style="font-size: 0.8rem;">${levelLabel}</span>
                                    ${roleBadge}
                                </div>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>E-Mail:</strong> ${user.email || 'N/A'}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Telefon:</strong> ${user.phone || 'N/A'}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Letzte Aktivit√§t:</strong> ${user.last_activity_at ? new Date(user.last_activity_at).toLocaleDateString('de-DE') : 'N/A'}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Mitglied seit:</strong> ${new Date(user.created_at).toLocaleDateString('de-DE')}
                                </p>
                                ${user.deactivated_at && user.deactivation_reason ? `
                                    <p style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 4px;">
                                        <strong>Deaktivierungsgrund:</strong> ${user.deactivation_reason}
                                    </p>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 5px; flex-direction: column; min-width: 150px;">
                                ${!user.is_admin && !user.is_super_admin && user.is_active ? `
                                    <button class="btn btn-danger" style="padding: 8px 16px;" onclick="deactivateUser(${user.id})">Deaktivieren</button>
                                ` : user.is_active && !user.is_super_admin ? `
                                    <button class="btn" style="padding: 8px 16px; background-color: #28a745;" onclick="activateUser(${user.id})">Aktivieren</button>
                                ` : !user.is_active ? `
                                    <button class="btn" style="padding: 8px 16px; background-color: #28a745;" onclick="activateUser(${user.id})">Aktivieren</button>
                                ` : ''}

                                ${currentUser && currentUser.is_super_admin && !user.is_super_admin ? `
                                    ${user.is_admin ? `
                                        <button class="btn-demote" onclick="demoteAdmin(${user.id}, '${user.name.replace(/'/g, "\\'")}')">Admin entfernen</button>
                                    ` : `
                                        <button class="btn-promote" onclick="promoteToAdmin(${user.id}, '${user.name.replace(/'/g, "\\'")}')">Zu Admin ernennen</button>
                                    `}
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getLevelLabel(level) {
            const labels = { green: 'Gr√ºn', blue: 'Blau', orange: 'Orange' };
            return labels[level] || level;
        }

        async function deactivateUser(id) {
            const reason = prompt('Grund f√ºr die Deaktivierung:');
            if (!reason) return;

            if (!confirm('Sind Sie sicher, dass Sie diesen Benutzer deaktivieren m√∂chten?')) {
                return;
            }

            try {
                await api.deactivateUser(id, reason);
                showAlert('success', 'Benutzer deaktiviert');
                loadUsers();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Deaktivieren');
            }
        }

        async function activateUser(id) {
            const message = prompt('Optional: Nachricht an den Benutzer:');

            if (!confirm('M√∂chten Sie diesen Benutzer aktivieren?')) {
                return;
            }

            try {
                await api.activateUser(id, message || null);
                showAlert('success', 'Benutzer aktiviert');
                loadUsers();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Aktivieren');
            }
        }

        async function promoteToAdmin(userId, userName) {
            if (!confirm(`M√∂chten Sie ${userName} wirklich zum Admin ernennen?\n\nAdmins haben Zugriff auf alle Verwaltungsfunktionen.`)) {
                return;
            }

            try {
                const result = await api.promoteToAdmin(userId);
                showAlert('success', `${userName} wurde erfolgreich zum Admin ernannt.`);
                loadUsers();
            } catch (error) {
                console.error('Error promoting user:', error);
                showAlert('error', error.message || 'Fehler beim Ernennen zum Admin');
            }
        }

        async function demoteAdmin(userId, userName) {
            if (!confirm(`M√∂chten Sie ${userName} wirklich die Admin-Rechte entziehen?\n\nDer Benutzer wird zu einem normalen Benutzer herabgestuft.`)) {
                return;
            }

            try {
                const result = await api.demoteAdmin(userId);
                showAlert('success', `Admin-Rechte von ${userName} wurden erfolgreich entzogen.`);
                loadUsers();
            } catch (error) {
                console.error('Error demoting admin:', error);
                showAlert('error', error.message || 'Fehler beim Entziehen der Admin-Rechte');
            }
        }

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>

    <style>
        .badge-super-admin {
            background-color: #d32f2f;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .badge-admin {
            background-color: #1976d2;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .btn-promote {
            background-color: #1976d2;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .btn-promote:hover {
            background-color: #1565c0;
        }

        .btn-demote {
            background-color: #f57c00;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .btn-demote:hover {
            background-color: #ef6c00;
        }
    </style>
</body>
</html>
