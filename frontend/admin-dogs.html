<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hunde verwalten - Gassigeher Admin</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <header>
        <div class="container">
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
            <a href="/" class="logo">üêï Gassigeher Admin</a>
            <nav id="main-nav">
                <ul>
                    <li><a href="/admin-dashboard.html" data-i18n="admin_dashboard.title">Dashboard</a></li>
                    <li><a href="/admin-dogs.html" data-i18n="dogs.manage_dogs">Hunde</a></li>
                    <li class="nav-dropdown">
                        <a href="#">Buchungen</a>
                        <div class="nav-dropdown-menu">
                            <a href="/admin-bookings.html">üìÖ Alle Buchungen</a>
                            <a href="/admin-booking-approvals.html">‚úì Genehmigungen</a>
                            <a href="/admin-booking-times.html">‚è∞ Buchungszeiten</a>
                            <a href="/admin-blocked-dates.html">üö´ Gesperrte Tage</a>
                        </div>
                    </li>
                    <li class="nav-dropdown">
                        <a href="#">Benutzer</a>
                        <div class="nav-dropdown-menu">
                            <a href="/admin-users.html">üë• Alle Benutzer</a>
                            <a href="/admin-experience-requests.html">‚≠ê Level-Anfragen</a>
                            <a href="/admin-reactivation-requests.html">üîÑ Reaktivierungen</a>
                        </div>
                    </li>
                    <li><a href="/admin-settings.html" data-i18n="admin_dashboard.system_settings">Einstellungen</a></li>
                    <li><a href="/dashboard.html" class="area-switcher" data-i18n="nav.user_area">üë§ Benutzer-Bereich</a></li>
                    <li><a href="#" onclick="api.logout()" data-i18n="nav.logout">Abmelden</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <div class="nav-overlay" id="nav-overlay" onclick="toggleMenu()"></div>

    <main style="padding: 40px 0;">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1 data-i18n="dogs.manage_dogs">Hunde verwalten</h1>
                <button class="btn" onclick="showAddDogForm()" data-i18n="dogs.add_dog">Hund hinzuf√ºgen</button>
            </div>

            <div id="alert-container"></div>

            <!-- Add/Edit Dog Form (hidden by default) -->
            <div id="dog-form-container" class="card hidden" style="margin-bottom: 30px;">
                <h3 id="form-title" data-i18n="dogs.add_dog">Hund hinzuf√ºgen</h3>
                <form id="dog-form">
                    <input type="hidden" id="dog-id">
                    <div class="form-group">
                        <label data-i18n="dogs.name">Name</label>
                        <input type="text" id="dog-name" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="dogs.breed">Rasse</label>
                        <input type="text" id="dog-breed" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="dogs.size">Gr√∂√üe</label>
                        <select id="dog-size" required>
                            <option value="small" data-i18n="dogs.size_small">Klein</option>
                            <option value="medium" data-i18n="dogs.size_medium">Mittel</option>
                            <option value="large" data-i18n="dogs.size_large">Gro√ü</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="dogs.age">Alter</label>
                        <input type="number" id="dog-age" min="0" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="dogs.category">Kategorie</label>
                        <select id="dog-category" required>
                            <option value="green" data-i18n="dogs.category_green">Gr√ºn</option>
                            <option value="blue" data-i18n="dogs.category_blue">Blau</option>
                            <option value="orange" data-i18n="dogs.category_orange">Orange</option>
                        </select>
                    </div>

                    <!-- Photo Upload Section -->
                    <div class="form-group">
                        <label>Foto</label>

                        <!-- Current Photo Display (shown when editing dog with photo) -->
                        <div id="current-photo-container" style="display: none;">
                            <!-- Populated by JavaScript -->
                        </div>

                        <!-- Photo Upload Zone -->
                        <div id="photo-upload-zone" class="photo-upload-zone">
                            <input type="file" id="dog-photo" accept="image/jpeg,image/png" style="display: none;">
                            <div class="upload-prompt">
                                <span class="upload-icon">üì∑</span>
                                <p style="margin: 10px 0 5px 0; font-weight: bold;">Foto hochladen</p>
                                <p class="upload-hint">Drag & Drop oder klicken</p>
                                <p class="upload-hint">JPEG/PNG, max 10MB</p>
                            </div>
                            <div id="photo-preview" class="photo-preview hidden">
                                <img id="preview-img" src="" alt="Preview" style="display: none;">
                                <button type="button" class="btn-remove-preview" onclick="dogPhotoManager.clearPreview()">&times;</button>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn" data-i18n="common.save">Speichern</button>
                        <button type="button" class="btn btn-secondary" onclick="hideForm()" data-i18n="common.cancel">Abbrechen</button>
                    </div>
                </form>
            </div>

            <!-- Dogs List -->
            <div id="dogs-list" class="dog-grid"></div>
        </div>
    </main>

    <script src="/js/nav-menu.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/dog-photo-helpers.js"></script>
    <script src="/js/dog-photo.js"></script>
    <script>
        let currentDogs = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            // Check if user is admin
            try {
                const userData = await api.getMe();
                if (!userData.is_admin) {
                    alert('Zugriff verweigert: Diese Seite ist nur f√ºr Administratoren zug√§nglich.');
                    window.location.href = '/dashboard.html';
                    return;
                }
            } catch (error) {
                console.error('Failed to verify admin status:', error);
                window.location.href = '/dashboard.html';
                return;
            }

            await window.i18n.load();

            // Explicitly update all translations after load
            console.log('i18n loaded, updating translations...');
            window.i18n.updateElement(document.body);

            loadDogs();

            document.getElementById('dog-form').addEventListener('submit', handleFormSubmit);

            // Initialize photo upload functionality
            initPhotoUpload();
        });

        function initPhotoUpload() {
            // Setup drag and drop
            dogPhotoManager.setupDragDrop('photo-upload-zone', handleFileSelected);

            // Setup file input change handler
            const fileInput = document.getElementById('dog-photo');
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleFileSelected(e.target.files[0]);
                    }
                });
            }
        }

        async function handleFileSelected(file) {
            try {
                await dogPhotoManager.previewFile(file, 'preview-img');
            } catch (error) {
                showAlert('error', error.message);
            }
        }

        async function loadDogs() {
            try {
                currentDogs = await api.getDogs();
                renderDogs();

                // Preload first 3 dog images for better performance
                preloadCriticalDogImages(currentDogs, 3);
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Laden der Hunde');
            }
        }

        function renderDogs() {
            const container = document.getElementById('dogs-list');
            if (currentDogs.length === 0) {
                container.innerHTML = '<p data-i18n="dogs.no_dogs">Keine Hunde gefunden</p>';
                return;
            }

            container.innerHTML = currentDogs.map(dog => `
                <div class="dog-card ${!dog.is_available ? 'unavailable' : ''}">
                    ${!dog.is_available ? `<div class="dog-unavailable-banner">${dog.unavailable_reason || 'Nicht verf√ºgbar'}</div>` : ''}
                    ${dog.is_featured ? `<div class="dog-featured-badge" title="Auf Startseite angezeigt">‚≠ê</div>` : ''}
                    ${getDogPhotoHtml(dog, false, 'dog-card-image', true, true)}
                    <div class="dog-card-body">
                        <div class="dog-category-badge ${dog.category}">${getCategoryLabel(dog.category)}</div>
                        <h3 class="dog-card-title">${dog.name}</h3>
                        <p class="dog-card-info">${dog.breed} ‚Ä¢ ${getSizeLabel(dog.size)} ‚Ä¢ ${dog.age} Jahre</p>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn" style="flex: 1; padding: 8px;" onclick="editDog(${dog.id})">‚úèÔ∏è</button>
                            <button class="btn ${dog.is_featured ? 'btn-warning' : 'btn-secondary'}" style="flex: 1; padding: 8px;" onclick="toggleFeatured(${dog.id}, ${!dog.is_featured})" title="${dog.is_featured ? 'Von Startseite entfernen' : 'Auf Startseite anzeigen'}">
                                ‚≠ê
                            </button>
                            <button class="btn btn-secondary" style="flex: 1; padding: 8px;" onclick="toggleAvailability(${dog.id}, ${!dog.is_available})">
                                ${dog.is_available ? 'üö´' : '‚úÖ'}
                            </button>
                            <button class="btn btn-danger" style="flex: 1; padding: 8px;" onclick="deleteDog(${dog.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getCategoryLabel(category) {
            const labels = { green: 'Gr√ºn', blue: 'Blau', orange: 'Orange' };
            return labels[category] || category;
        }

        function getSizeLabel(size) {
            const labels = { small: 'Klein', medium: 'Mittel', large: 'Gro√ü' };
            return labels[size] || size;
        }

        function showAddDogForm() {
            document.getElementById('form-title').textContent = 'Hund hinzuf√ºgen';
            document.getElementById('dog-form').reset();
            document.getElementById('dog-id').value = '';
            document.getElementById('dog-form-container').classList.remove('hidden');

            // Reset photo upload UI
            dogPhotoManager.reset();

            // Scroll to form
            document.getElementById('dog-form-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function editDog(id) {
            const dog = currentDogs.find(d => d.id === id);
            if (!dog) return;

            document.getElementById('form-title').textContent = 'Hund bearbeiten';
            document.getElementById('dog-id').value = dog.id;
            document.getElementById('dog-name').value = dog.name;
            document.getElementById('dog-breed').value = dog.breed;
            document.getElementById('dog-size').value = dog.size;
            document.getElementById('dog-age').value = dog.age;
            document.getElementById('dog-category').value = dog.category;
            document.getElementById('dog-form-container').classList.remove('hidden');

            // Initialize photo UI for this dog
            dogPhotoManager.initForDog(dog);

            // Scroll to form so user sees it's populated
            document.getElementById('dog-form-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideForm() {
            document.getElementById('dog-form-container').classList.add('hidden');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const id = document.getElementById('dog-id').value;
            const data = {
                name: document.getElementById('dog-name').value,
                breed: document.getElementById('dog-breed').value,
                size: document.getElementById('dog-size').value,
                age: parseInt(document.getElementById('dog-age').value),
                category: document.getElementById('dog-category').value,
            };

            try {
                let dogId = id;

                // Create or update dog
                if (id) {
                    await api.updateDog(id, data);
                } else {
                    const result = await api.createDog(data);
                    dogId = result.id;
                }

                // Upload photo if one is selected
                if (dogPhotoManager.selectedFile && dogId) {
                    try {
                        await dogPhotoManager.uploadSelectedFile(dogId);
                        showAlert('success', id ? 'Hund und Foto erfolgreich aktualisiert' : 'Hund und Foto erfolgreich hinzugef√ºgt');
                    } catch (photoError) {
                        // Dog was saved but photo upload failed
                        showAlert('warning', id ?
                            'Hund aktualisiert, aber Foto-Upload fehlgeschlagen: ' + photoError.message :
                            'Hund hinzugef√ºgt, aber Foto-Upload fehlgeschlagen: ' + photoError.message);
                    }
                } else {
                    showAlert('success', id ? 'Hund erfolgreich aktualisiert' : 'Hund erfolgreich hinzugef√ºgt');
                }

                hideForm();
                loadDogs();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Speichern');
            }
        }

        async function toggleAvailability(id, makeAvailable) {
            // If making unavailable, ask for reason
            let reason = null;
            if (!makeAvailable) {
                reason = prompt('Grund f√ºr Nichtverf√ºgbarkeit:');
                if (!reason) return; // Cancel if no reason provided
            }

            try {
                await api.toggleDogAvailability(id, makeAvailable, reason);
                showAlert('success', makeAvailable ? 'Hund ist jetzt verf√ºgbar' : 'Hund ist jetzt nicht verf√ºgbar');
                loadDogs();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Aktualisieren');
            }
        }

        async function toggleFeatured(id, makeFeatured) {
            try {
                await api.setDogFeatured(id, makeFeatured);
                showAlert('success', makeFeatured ? 'Hund wird auf der Startseite angezeigt' : 'Hund von Startseite entfernt');
                loadDogs();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Aktualisieren (max. 3 Featured-Hunde)');
            }
        }

        async function deleteDog(id) {
            if (!confirm('Sind Sie sicher, dass Sie diesen Hund l√∂schen m√∂chten?')) return;

            try {
                await api.deleteDog(id);
                showAlert('success', 'Hund erfolgreich gel√∂scht');
                loadDogs();
            } catch (error) {
                // Check if error is due to future bookings
                if (error.status === 409 && error.data && error.data.bookings) {
                    // Show custom dialog with booking list
                    showBookingsDialog(id, error.data.bookings);
                } else {
                    showAlert('error', error.message || 'Fehler beim L√∂schen');
                }
            }
        }

        function showBookingsDialog(dogId, bookings) {
            // Create modal dialog
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;

            const dialogContent = document.createElement('div');
            dialogContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 8px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;

            // Build booking list HTML
            const bookingList = bookings.map(booking => {
                const userName = booking.User?.name || 'Unbekannt';
                return `
                    <li style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                        <strong>${booking.date}</strong> - ${booking.scheduled_time || ''} Uhr
                        <br>
                        <small>Benutzer: ${userName}</small>
                    </li>
                `;
            }).join('');

            dialogContent.innerHTML = `
                <h3 style="margin-top: 0; color: #dc3545;">‚ö†Ô∏è Dieser Hund hat zuk√ºnftige Buchungen</h3>
                <p style="margin: 15px 0;">Folgende Buchungen sind f√ºr diesen Hund geplant:</p>
                <ul style="list-style: none; padding: 0; margin: 20px 0;">
                    ${bookingList}
                </ul>
                <p style="margin: 20px 0; font-weight: bold;">
                    M√∂chten Sie alle diese Buchungen stornieren und die betroffenen Benutzer per E-Mail benachrichtigen?
                </p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="confirm-force-delete" class="btn btn-danger" style="flex: 1;">
                        Ja, alle Buchungen stornieren und Hund l√∂schen
                    </button>
                    <button id="cancel-delete" class="btn btn-secondary" style="flex: 1;">
                        Nein, Hund behalten
                    </button>
                </div>
            `;

            dialog.appendChild(dialogContent);
            document.body.appendChild(dialog);

            // Handle button clicks
            document.getElementById('confirm-force-delete').addEventListener('click', async () => {
                dialog.remove();
                await forceDeleteDog(dogId, bookings.length);
            });

            document.getElementById('cancel-delete').addEventListener('click', () => {
                dialog.remove();
            });

            // Close on background click
            dialog.addEventListener('click', (e) => {
                if (e.target === dialog) {
                    dialog.remove();
                }
            });
        }

        async function forceDeleteDog(id, bookingCount) {
            try {
                const result = await api.deleteDog(id, true); // force=true
                const message = `Hund wurde gel√∂scht und ${result.cancelled_count || bookingCount} Buchung(en) wurden storniert. Betroffene Benutzer wurden per E-Mail benachrichtigt.`;
                showAlert('success', message);
                loadDogs();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim L√∂schen');
            }
        }

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>
</body>
</html>
