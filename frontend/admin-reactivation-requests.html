<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reaktivierungsanfragen - Gassigeher Admin</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <header>
        <div class="container">
            <a href="/" class="logo">üêï Gassigeher Admin</a>
            <nav>
                <ul>
                    <li><a href="/admin-dashboard.html" data-i18n="admin_dashboard.title">Dashboard</a></li>
                    <li><a href="/admin-dogs.html" data-i18n="dogs.manage_dogs">Hunde</a></li>
                    <li><a href="/admin-bookings.html" data-i18n="admin.manage_bookings">Buchungen</a></li>
                    <li><a href="/admin-blocked-dates.html" data-i18n="admin.manage_blocked_dates">Gesperrte Tage</a></li>
                    <li><a href="/admin-experience-requests.html" data-i18n="admin.manage_experience_requests">Level-Anfragen</a></li>
                    <li><a href="/admin-users.html" data-i18n="users.title">Benutzer</a></li>
                    <li><a href="/admin-reactivation-requests.html" data-i18n="reactivation.manage_requests">Reaktivierungen</a></li>
                    <li><a href="/admin-settings.html" data-i18n="admin_dashboard.system_settings">Einstellungen</a></li>
                    <li><a href="#" onclick="api.logout()" data-i18n="nav.logout">Abmelden</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main style="padding: 40px 0;">
        <div class="container">
            <h1 data-i18n="reactivation.manage_requests">Reaktivierungsanfragen</h1>

            <div id="alert-container"></div>

            <!-- Pending Requests -->
            <div id="requests-list"></div>
        </div>
    </main>

    <script src="/js/i18n.js"></script>
    <script src="/js/api.js"></script>
    <script>
        let requests = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            await window.i18n.load();
            loadRequests();
        });

        async function loadRequests() {
            try {
                requests = await api.getReactivationRequests();
                renderRequests();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Laden der Anfragen');
            }
        }

        function renderRequests() {
            const container = document.getElementById('requests-list');

            if (requests.length === 0) {
                container.innerHTML = '<div class="card"><p data-i18n="reactivation.no_requests">Keine ausstehenden Anfragen</p></div>';
                return;
            }

            container.innerHTML = requests.map(request => {
                return `
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 10px 0;">${request.user ? request.user.name : 'User #' + request.user_id}</h4>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>E-Mail:</strong> ${request.user && request.user.email ? request.user.email : 'N/A'}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Level:</strong> ${request.user ? getLevelLabel(request.user.experience_level) : 'N/A'}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Deaktiviert seit:</strong> ${request.user && request.user.deactivated_at ? new Date(request.user.deactivated_at).toLocaleDateString('de-DE') : 'N/A'}
                                </p>
                                ${request.user && request.user.deactivation_reason ? `
                                    <p style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 4px;">
                                        <strong>Deaktivierungsgrund:</strong> ${request.user.deactivation_reason}
                                    </p>
                                ` : ''}
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Anfrage vom:</strong> ${new Date(request.created_at).toLocaleDateString('de-DE')}
                                </p>
                            </div>
                            ${request.status === 'pending' ? `
                                <div style="display: flex; gap: 5px; flex-direction: column; min-width: 120px;">
                                    <button class="btn" style="padding: 8px 16px; background-color: #28a745;" onclick="approveRequest(${request.id})">Genehmigen</button>
                                    <button class="btn btn-danger" style="padding: 8px 16px;" onclick="denyRequest(${request.id})">Ablehnen</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getLevelLabel(level) {
            const labels = { green: 'Gr√ºn', blue: 'Blau', orange: 'Orange' };
            return labels[level] || level;
        }

        async function approveRequest(id) {
            const message = prompt('Optional: Nachricht an den Benutzer:');

            try {
                await api.approveReactivationRequest(id, message || null);
                showAlert('success', 'Anfrage genehmigt und Benutzer reaktiviert');
                loadRequests();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Genehmigen');
            }
        }

        async function denyRequest(id) {
            const message = prompt('Optional: Nachricht an den Benutzer (Grund der Ablehnung):');

            if (!confirm('M√∂chten Sie diese Reaktivierungsanfrage wirklich ablehnen?')) {
                return;
            }

            try {
                await api.denyReactivationRequest(id, message || null);
                showAlert('success', 'Anfrage abgelehnt');
                loadRequests();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Ablehnen');
            }
        }

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>
</body>
</html>
