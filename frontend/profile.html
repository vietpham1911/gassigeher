<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - Gassigeher</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <header>
        <div class="container">
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
            <a href="/" class="logo">üêï Gassigeher</a>
            <nav id="main-nav">
                <ul>
                    <li><a href="/dashboard.html" data-i18n="nav.dashboard">Dashboard</a></li>
                    <li><a href="/dogs.html" data-i18n="dogs.all_dogs">Hunde</a></li>
                    <li><a href="/calendar.html" data-i18n="nav.calendar">Kalender</a></li>
                    <li><a href="/profile.html" style="display: flex; align-items: center; gap: 8px;">
                        <span id="header-photo" style="width: 32px; height: 32px; border-radius: 50%; background: #ddd; display: inline-flex; align-items: center; justify-content: center; overflow: hidden;">üë§</span>
                        <span data-i18n="nav.profile">Profil</span>
                    </a></li>
                    <li id="admin-area-link" style="display: none;"><a href="/admin-dashboard.html" class="area-switcher" data-i18n="nav.admin_area">üîß Admin-Bereich</a></li>
                    <li><a href="#" onclick="api.logout()" data-i18n="nav.logout">Abmelden</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <div class="nav-overlay" id="nav-overlay" onclick="toggleMenu()"></div>

    <main style="padding: 40px 0;">
        <div class="container-narrow">
            <h1 data-i18n="profile.title">Profil</h1>

            <div id="alert-container"></div>

            <!-- Profile Photo -->
            <div class="card">
                <h3>Profilfoto</h3>
                <div style="text-align: center; margin: 20px 0;">
                    <div id="photo-preview" style="width: 150px; height: 150px; margin: 0 auto 20px; border-radius: 50%; overflow: hidden; background: #ddd; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 3rem;">üë§</span>
                    </div>
                    <input type="file" id="photo-input" accept="image/jpeg,image/png" style="display: none;" onchange="uploadPhoto()">
                    <button class="btn" onclick="document.getElementById('photo-input').click()">Foto hochladen</button>
                </div>
            </div>

            <!-- Profile Info -->
            <div class="card">
                <h3 data-i18n="profile.edit_profile">Profil bearbeiten</h3>
                <form id="profile-form">
                    <div class="form-group">
                        <label data-i18n="auth.name">Name</label>
                        <input type="text" id="edit-name" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.email">E-Mail-Adresse</label>
                        <input type="email" id="edit-email" required>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                            Hinweis: Bei √Ñnderung der E-Mail m√ºssen Sie diese erneut best√§tigen.
                        </p>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.phone">Telefonnummer</label>
                        <input type="tel" id="edit-phone" required
                               pattern="\+?[0-9\s\-\.\(\)]{7,20}"
                               placeholder="z.B. 0123 456789 oder +49 123 456789"
                               title="Bitte geben Sie eine g√ºltige Telefonnummer ein (z.B. 0123 456789 oder +49 123 456789)">
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                            Format: z.B. 0123 456789, +49 123 456789 oder 0123-456789
                        </p>
                    </div>
                    <button type="submit" class="btn" data-i18n="common.save">Speichern</button>
                </form>
            </div>

            <!-- Experience Level -->
            <div class="card">
                <h3 data-i18n="profile.current_level">Aktuelles Level</h3>
                <div style="margin: 20px 0;">
                    <span id="current-level-badge" class="dog-category-badge" style="font-size: 1.2rem;"></span>
                </div>

                <div id="promotion-section">
                    <p data-i18n="profile.promotion_description">Beantragen Sie ein h√∂heres Erfahrungslevel, um Zugang zu anspruchsvolleren Hunden zu erhalten.</p>

                    <div style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 6px;">
                        <p style="margin: 5px 0;"><strong style="color: #28a745;">‚óè</strong> <span data-i18n="profile.level_green_desc">Gr√ºn: F√ºr alle Anf√§nger</span></p>
                        <p style="margin: 5px 0;"><strong style="color: #17a2b8;">‚óè</strong> <span data-i18n="profile.level_blue_desc">Blau: F√ºr erfahrene Gassigeher</span></p>
                        <p style="margin: 5px 0;"><strong style="color: #ffc107;">‚óè</strong> <span data-i18n="profile.level_orange_desc">Orange: Nur f√ºr erfahrene Gassigeher</span></p>
                    </div>

                    <div id="promotion-buttons"></div>
                </div>
            </div>

            <!-- My Experience Requests -->
            <div class="card">
                <h3 data-i18n="profile.your_requests">Ihre Anfragen</h3>
                <div id="my-requests"></div>
            </div>

            <!-- Change Password -->
            <div class="card">
                <h3 data-i18n="profile.change_password">Passwort √§ndern</h3>
                <form id="password-form">
                    <div class="form-group">
                        <label data-i18n="auth.old_password">Altes Passwort</label>
                        <input type="password" id="old-password" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.new_password">Neues Passwort</label>
                        <input type="password" id="new-password" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.confirm_new_password">Neues Passwort best√§tigen</label>
                        <input type="password" id="confirm-password" required>
                    </div>
                    <button type="submit" class="btn" data-i18n="auth.change_password">Passwort √§ndern</button>
                </form>
            </div>

            <!-- Account Deletion (GDPR) -->
            <div class="card" style="border-left: 4px solid #dc3545;">
                <h3 style="color: #dc3545;" data-i18n="profile.delete_account">Konto l√∂schen</h3>
                <div style="background: #f8d7da; padding: 15px; border-radius: 6px; margin: 20px 0;">
                    <p style="margin: 0; color: #721c24; font-weight: 600;" data-i18n="profile.delete_account_warning">WARNUNG: Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!</p>
                </div>
                <p data-i18n="profile.delete_account_info">Ihre pers√∂nlichen Daten werden gel√∂scht, aber Ihre Spaziergangshistorie wird anonymisiert aufbewahrt.</p>
                <button class="btn btn-danger" onclick="confirmDeleteAccount()" data-i18n="profile.delete_account">Konto l√∂schen</button>
            </div>
        </div>
    </main>

    <script src="/js/nav-menu.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/api.js"></script>
    <script>
        let currentUser = null;
        let myRequests = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            await window.i18n.load();

            // Explicitly update all translations after load
            console.log('i18n loaded, updating translations...');
            window.i18n.updateElement(document.body);

            try {
                currentUser = await api.getMe();
                updateHeaderPhoto();
                showAdminLinkIfAdmin(currentUser);
                loadMyRequests();
                renderProfile();
                renderPromotionButtons();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Laden');
            }

            document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);
            document.getElementById('password-form').addEventListener('submit', handlePasswordChange);
        });

        function updateHeaderPhoto() {
            if (currentUser && currentUser.profile_photo) {
                const headerPhoto = document.getElementById('header-photo');
                headerPhoto.innerHTML = `<img src="/uploads/${currentUser.profile_photo}" style="width: 100%; height: 100%; object-fit: cover;" alt="Profile">`;
            }
        }

        function renderProfile() {
            // Populate edit form
            document.getElementById('edit-name').value = currentUser.name;
            document.getElementById('edit-email').value = currentUser.email || '';
            document.getElementById('edit-phone').value = currentUser.phone || '';

            // Display profile photo
            if (currentUser.profile_photo) {
                const photoPreview = document.getElementById('photo-preview');
                photoPreview.innerHTML = `<img src="/uploads/${currentUser.profile_photo}" style="width: 100%; height: 100%; object-fit: cover;" alt="Profile">`;
            }

            // Display experience level
            const levelBadge = document.getElementById('current-level-badge');
            levelBadge.className = `dog-category-badge ${currentUser.experience_level}`;
            levelBadge.textContent = getLevelLabel(currentUser.experience_level);
        }

        function renderPromotionButtons() {
            const container = document.getElementById('promotion-buttons');
            const currentLevel = currentUser.experience_level;

            if (currentLevel === 'orange') {
                container.innerHTML = '<p style="color: #28a745; font-weight: 600;">Sie haben das h√∂chste Level erreicht!</p>';
                return;
            }

            // Check for pending requests
            const hasPendingBlue = myRequests.some(r => r.requested_level === 'blue' && r.status === 'pending');
            const hasPendingOrange = myRequests.some(r => r.requested_level === 'orange' && r.status === 'pending');

            let buttons = '';

            if (currentLevel === 'green') {
                if (hasPendingBlue) {
                    buttons += '<button class="btn" disabled>Blau Level beantragt</button>';
                } else {
                    buttons += '<button class="btn" onclick="requestPromotion(\'blue\')">Blau Level beantragen</button>';
                }
            }

            if (currentLevel === 'blue') {
                if (hasPendingOrange) {
                    buttons += '<button class="btn" disabled>Orange Level beantragt</button>';
                } else {
                    buttons += '<button class="btn" onclick="requestPromotion(\'orange\')">Orange Level beantragen</button>';
                }
            }

            container.innerHTML = buttons;
        }

        function getLevelLabel(level) {
            const labels = { green: 'Gr√ºn', blue: 'Blau', orange: 'Orange' };
            return labels[level] || level;
        }

        async function loadMyRequests() {
            try {
                myRequests = await api.getExperienceRequests();
                renderMyRequests();
                renderPromotionButtons();
            } catch (error) {
                console.error('Failed to load requests:', error);
            }
        }

        function renderMyRequests() {
            const container = document.getElementById('my-requests');

            if (myRequests.length === 0) {
                container.innerHTML = '<p data-i18n="profile.no_requests">Keine Anfragen</p>';
                return;
            }

            container.innerHTML = myRequests.map(request => {
                const statusClass = request.status === 'approved' ? 'alert-success' :
                                  (request.status === 'denied' ? 'alert-error' : 'alert-info');
                const statusLabel = getStatusLabel(request.status);

                return `
                    <div class="card" style="margin-bottom: 15px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="margin: 0 0 10px 0;">${getLevelLabel(request.requested_level)} Level</h4>
                                <p style="margin: 5px 0; font-size: 0.9rem;">
                                    Beantragt am: ${new Date(request.created_at).toLocaleDateString('de-DE')}
                                </p>
                                ${request.reviewed_at ? `<p style="margin: 5px 0; font-size: 0.9rem;">Gepr√ºft am: ${new Date(request.reviewed_at).toLocaleDateString('de-DE')}</p>` : ''}
                                ${request.admin_message ? `<p style="margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px;"><strong>Nachricht:</strong> ${request.admin_message}</p>` : ''}
                            </div>
                            <span class="alert ${statusClass}" style="padding: 6px 12px; font-size: 0.85rem; margin: 0;">${statusLabel}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusLabel(status) {
            const labels = {
                pending: 'Ausstehend',
                approved: 'Genehmigt',
                denied: 'Abgelehnt'
            };
            return labels[status] || status;
        }

        async function requestPromotion(level) {
            if (!confirm(`M√∂chten Sie ${getLevelLabel(level)} Level beantragen?`)) {
                return;
            }

            try {
                await api.createExperienceRequest(level);
                showAlert('success', 'Antrag erfolgreich eingereicht');
                loadMyRequests();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Einreichen des Antrags');
            }
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();

            // Check HTML5 form validity first
            const form = e.target;
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const name = document.getElementById('edit-name').value;
            const email = document.getElementById('edit-email').value;
            const phone = document.getElementById('edit-phone').value;

            // Additional phone validation
            const phonePattern = /^[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,9}$/;
            if (!phonePattern.test(phone)) {
                showAlert('error', 'Bitte geben Sie eine g√ºltige Telefonnummer ein (z.B. 0123 456789 oder +49 123 456789)');
                return;
            }

            try {
                const response = await api.updateMe({ name, email, phone });
                showAlert('success', response.message || 'Profil aktualisiert');

                // Reload user data
                currentUser = await api.getMe();
                renderProfile();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Aktualisieren');
            }
        }

        async function uploadPhoto() {
            const fileInput = document.getElementById('photo-input');
            const file = fileInput.files[0];

            if (!file) return;

            // Validate file type
            if (!file.type.match(/image\/(jpeg|jpg|png)/)) {
                showAlert('error', 'Nur JPEG und PNG Dateien sind erlaubt');
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('error', 'Datei zu gro√ü (max. 5MB)');
                return;
            }

            // Preview image
            const reader = new FileReader();
            reader.onload = (e) => {
                const photoPreview = document.getElementById('photo-preview');
                photoPreview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;" alt="Preview">`;
            };
            reader.readAsDataURL(file);

            // Upload
            try {
                const response = await api.uploadPhoto(file);
                showAlert('success', 'Foto erfolgreich hochgeladen');

                // Reload user data
                currentUser = await api.getMe();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Hochladen');
            }
        }

        async function handlePasswordChange(e) {
            e.preventDefault();

            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showAlert('error', 'Passw√∂rter stimmen nicht √ºberein');
                return;
            }

            try {
                await api.changePassword(oldPassword, newPassword, confirmPassword);
                showAlert('success', 'Passwort erfolgreich ge√§ndert');
                document.getElementById('password-form').reset();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim √Ñndern des Passworts');
            }
        }

        async function confirmDeleteAccount() {
            if (!confirm('WARNUNG: Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!\n\nIhre pers√∂nlichen Daten werden gel√∂scht, aber Ihre Spaziergangshistorie wird anonymisiert aufbewahrt.\n\nM√∂chten Sie fortfahren?')) {
                return;
            }

            const password = prompt('Geben Sie Ihr Passwort ein, um die L√∂schung zu best√§tigen:');
            if (!password) return;

            try {
                await api.deleteAccount(password);
                alert('Ihr Konto wurde gel√∂scht. Sie erhalten eine Best√§tigungs-E-Mail.');

                // Logout and redirect
                api.setToken(null);
                window.location.href = '/';
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim L√∂schen des Kontos');
            }
        }

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>
</body>
</html>
