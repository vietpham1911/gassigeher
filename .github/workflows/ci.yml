name: ci

on: push

jobs:
  check-new-code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with: 
          go-version: 1.24
      - name: Run tests
        run: go test ./...
      - name: Node.js Setup
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
        working-directory: e2e-tests
      - name: Install browser
        run: npx playwright install chromium --with-deps
      - name: Start Go-server
        run: |
          go build -o gassigeher ./cmd/server
          DATABASE_PATH=./test.db JWT_SECRET=test SUPER_ADMIN_EMAIL=test@test.com ./gassigeher > server.log 2>&1 &
          sleep 3
          cat server.log
      - name: Wait for server
        run: |
          for i in {1..30}; do
            curl -s http://localhost:8080/api/health && break
            sleep 2
          done
          curl -sf http://localhost:8080/api/health
      - name: Run playwright
        run: npm test
        working-directory: e2e-tests